05-241023  
松尾凜太朗  

Intel SDM Vol6. 4.7 PAGE-FAULT EXCEPTIONSにあるように、14番がPage faultの割り込み番号である。  
割り込み発生時、CR2レジスタには、アクセスに失敗したアドレスが入っている。
error codeからは、例えばページフォルトが読み込みで発生したのか書き込みで発生したのかという情報が得られる。  

今回は、仮想アドレスの0x300000000から1ページをkernel領域の直後の1ページ分にマップすることにした。
マップされた際デバッグ出力が生じ、以後はPage faultが生じないことが確認できる。  

もしマップされていないページへのアクセスをする命令が実行されると、メモリアクセスの際にページテーブルを引く役割をしているCPUのMMUがこれを検知し、CPUに割り込みが発生する。  
IDTを通じて割り込みハンドラが呼ばれ、interrupt_handler.Sのpage_fault_handlerが汎用レジスタを退避し、page_fault_handler_internalを呼ぶ。  
ここでは、CR2レジスタからアクセスしようとしたアドレスを取得し、それが0x300000000からの1ページである場合のみそれをマップして、戻っている。  
この際、割り込みを生じた命令をやり直すということが必要になると考えていたが、それをどのように行うのか、また現在行われているのかは分からなかった。
interrupt_handler.Sでは、エラーコードの分最後にrspに8を足している。  


